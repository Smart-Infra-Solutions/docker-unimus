# Stage 1: Download and verify
FROM debian:stable-slim AS downloader
ARG DEBIAN_FRONTEND=noninteractive

# Set Unimus latest download url
ENV DOWNLOAD_URL=https://download.unimus.net/unimus/-%20Latest/Unimus.jar

# Optional: Set expected SHA256 checksum for JAR verification
ARG JAR_SHA256="7cca710b8e735064d3a945e5a8451434832466c879621b0a08c58338b33061f5"

# Install download tools
RUN apt-get update && \
    apt-get install -y curl && \
    apt-get clean && \
    rm -rf /var/lib/{apt,dpkg,cache,log}/

# Download and verify JAR
RUN curl -L -o /opt/unimus.jar $DOWNLOAD_URL && \
    if [ ! -z "$JAR_SHA256" ]; then \
        echo "$JAR_SHA256  /opt/unimus.jar" | sha256sum -c - || { echo "Checksum verification failed!"; exit 1; }; \
        echo "JAR checksum verified successfully"; \
    else \
        echo "Warning: Skipping checksum verification (JAR_SHA256 not set)"; \
    fi

# Stage 2: Final runtime image
FROM debian:stable-slim
ARG DEBIAN_FRONTEND=noninteractive

# Install only runtime dependencies (no curl needed)
RUN apt-get update && \
    apt-get install -y apt-utils dialog tini less wget tzdata openjdk-25-jre-headless iputils-ping && \
    apt-get clean && \
    apt-get autoremove --yes && \
    rm -rf /var/lib/{apt,dpkg,cache,log}/

# Copy verified JAR from downloader stage
COPY --from=downloader /opt/unimus.jar /opt/unimus.jar

# Copy start script
COPY files/* /opt/
RUN chmod +x /opt/start.sh

# Expose Unimus web interface port
EXPOSE 8085

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:8085/ || exit 1

# Entrypoint
ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["/opt/start.sh"]
